<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mieloka â€” Marketplace Mie Lokal</title>
  <meta name="description" content="Mieloka â€” UMKM lokal F&B. Martabak, Somtam, Tomyam, Mie Thai, Es Jimi. Pesan via WhatsApp." />
  <style>
    :root{
      --bg:#071226; --card:#0d1624; --accent:#ffb86b; --text:#e6eef6; --muted:#98a6b6;
      --radius:10px; --container:1100px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,Arial;background:var(--bg);color:var(--text)}
    .wrap{max-width:var(--container);margin:28px auto;padding:20px}
    header{display:flex;justify-content:space-between;gap:12px;align-items:center}
    .brand h1{margin:0;color:var(--accent)}
    .lead{color:var(--muted);font-size:13px}
    .controls{display:flex;gap:12px;margin-top:18px;flex-wrap:wrap}
    .search{flex:1;min-width:220px;background:rgba(255,255,255,0.02);padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);display:flex;align-items:center;gap:8px}
    .search input{background:transparent;border:0;outline:0;color:var(--text);width:100%}
    .filters{display:flex;gap:8px;flex-wrap:wrap}
    .chip{padding:8px 12px;border-radius:999px;background:transparent;border:1px solid rgba(255,255,255,0.03);color:var(--muted);cursor:pointer;font-size:13px}
    .chip.active{border-color:rgba(255,255,255,0.12);color:var(--text);background:rgba(255,255,255,0.02)}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:14px;margin-top:18px}
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.015), rgba(255,255,255,0.01));padding:10px;border-radius:var(--radius);border:1px solid rgba(255,255,255,0.02)}
    .thumb{height:130px;border-radius:8px;overflow:hidden;background:#091421;display:flex;align-items:center;justify-content:center}
    .thumb img{width:100%;height:100%;object-fit:cover}
    .title{font-weight:700}
    .price{color:var(--accent);font-weight:800}
    .row{display:flex;justify-content:space-between;align-items:center;margin-top:8px}
    .btn{background:var(--accent);color:#071226;border:none;padding:8px 12px;border-radius:8px;cursor:pointer;font-weight:700}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted)}
    .cart-float{position:fixed;right:18px;bottom:18px;background:var(--accent);padding:12px 14px;border-radius:999px;z-index:999;cursor:pointer;color:#071226}
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.6);z-index:1200;padding:16px}
    .panel{width:100%;max-width:860px;background:var(--card);padding:18px;border-radius:12px;border:1px solid rgba(255,255,255,0.02)}
    label{display:block;margin-bottom:6px;color:var(--muted);font-size:13px}
    input[type="text"], input[type="tel"], textarea, select{width:100%;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:var(--text)}
    textarea{min-height:72px;resize:vertical}
    .small{font-size:13px;color:var(--muted)}
    footer{margin-top:20px;color:var(--muted);font-size:13px;text-align:center}
    @media(max-width:720px){header{flex-direction:column;align-items:flex-start}.controls{flex-direction:column}}
  </style>
</head>
<body>
  <main class="wrap" role="main">
    <header>
      <div class="brand">
        <div>
          <h1>MIELOKA</h1>
          <div class="lead">UMKM Lokal â€” Martabak â€¢ Somtam â€¢ Tomyam â€¢ Mie â€¢ Es Jimi</div>
        </div>
      </div>
      <div>
        <div class="small">WA Owner: <a href="https://wa.me/6285816415868" style="color:var(--accent);text-decoration:none">+62 858-1641-5868</a></div>
      </div>
    </header>

    <section class="controls" aria-label="Controls">
      <div class="search" role="search">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" style="opacity:.8"><path d="M21 21l-4.35-4.35" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/><circle cx="11" cy="11" r="6" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/></svg>
        <input id="search" placeholder="Cari menu (mis. tomyam, martabak)"/>
      </div>

      <div class="filters" role="list" aria-label="Filter kategori">
        <button class="chip active" data-cat="all">Semua</button>
        <button class="chip" data-cat="martabak">Martabak</button>
        <button class="chip" data-cat="somtam">Somtam</button>
        <button class="chip" data-cat="tomyam">Tomyam</button>
        <button class="chip" data-cat="mie">Mie</button>
        <button class="chip" data-cat="dessert">Dessert</button>
      </div>
    </section>

    <section id="catalog" class="grid" aria-live="polite"></section>

    <footer>Â© <span id="year"></span> Mieloka â€” UMKM Lokal</footer>
  </main>

  <div class="cart-float" id="cart-float">ðŸ›’ Keranjang (<span id="cart-count">0</span>)</div>

  <!-- Checkout Modal -->
  <div class="modal" id="modal" aria-hidden="true">
    <div class="panel" role="dialog" aria-modal="true">
      <h3>Checkout â€” Isi Data Pemesanan</h3>

      <div style="margin-bottom:10px">
        <label>Ringkasan Pesanan</label>
        <div id="order-summary" style="background:rgba(255,255,255,0.02);padding:8px;border-radius:8px;font-size:13px"></div>
      </div>

      <!-- Checkout form (will be submitted to Google Form via hidden HTML form) -->
      <form id="checkout-form">
        <div style="margin-bottom:8px">
          <label>Nama Pemesan *</label>
          <input id="cust-name" type="text" required />
        </div>
        <div style="margin-bottom:8px">
          <label>No. Telepon / WhatsApp *</label>
          <input id="cust-tel" type="tel" placeholder="08xxxxxxxxxx" required />
        </div>
        <div style="margin-bottom:8px">
          <label>Alamat Lengkap</label>
          <textarea id="cust-address"></textarea>
        </div>

        <div style="display:flex;gap:8px;margin-bottom:8px">
          <div style="flex:1">
            <label>Pengantaran *</label>
            <select id="cust-delivery" required>
              <option value="Pickup">Pickup</option>
              <option value="Kurir Lokal">Kurir Lokal</option>
              <option value="GoFood/GrabFood">GoFood / GrabFood</option>
            </select>
          </div>
          <div style="width:220px">
            <label>Pembayaran *</label>
            <select id="cust-pay" required>
              <option value="COD">COD (Bayar di tempat)</option>
              <option value="E-Wallet (OVO,Dana,ShopeePay)">E-Wallet (OVO / DANA / Shopeepay)</option>
              <option value="Transfer Bank">Transfer Bank</option>
            </select>
          </div>
        </div>

        <div style="margin-bottom:8px">
          <label>Catatan</label>
          <textarea id="cust-note" placeholder="Contoh: tanpa cabe, bungkus terpisah"></textarea>
        </div>

        <div style="text-align:right;display:flex;gap:8px;justify-content:flex-end">
          <button type="button" class="btn ghost" id="btn-cancel">Batal</button>
          <button type="submit" class="btn" id="btn-submit">Kirim Pesanan</button>
        </div>

        <div id="submit-message" class="small" style="margin-top:10px"></div>
      </form>
    </div>
  </div>

  <script>
    /******** CONFIG (tetap gunakan mapping & action yang sudah kamu punya) ********/
    const GOOGLE_FORM_ACTION_URL = 'https://docs.google.com/forms/d/e/1FAIpQLSe5psqJPU768dvuCwbjXtdExS6j1AyUexcjBTJvYPWW0Cb0TA/formResponse';
    const GF_ENTRY_IDS = {
      cust_name: 'entry.398970537',
      cust_tel: 'entry.1806170338',
      cust_address: 'entry.822463516',
      cust_delivery: 'entry.843995223',
      cust_pay: 'entry.801141337',
      cust_note: 'entry.610885754',
      order_summary: 'entry.1361649100'
    };
    const OWNER_WA_NUMBER = '6285816415868';
    /**************************************************************************/

    // MENU (dengan kategori)
    const PRODUCTS = [
      // Martabak
      {id:'m1', name:'Martabak Mie', category:'martabak', price:22000},
      {id:'m2', name:'Martabak Usus', category:'martabak', price:25000},
      {id:'m3', name:'Martabak Ayam', category:'martabak', price:27000},
      {id:'m4', name:'Martabak Rempelo Ati', category:'martabak', price:27000},
      {id:'m5', name:'Martabak Gajeh', category:'martabak', price:28000},
      {id:'m6', name:'Martabak Aneka Rasa + Level', category:'martabak', price:29000},
      // Somtam
      {id:'s1', name:'Somtam Tanpa Protein', category:'somtam', price:25000},
      {id:'s2', name:'Somtam Udang', category:'somtam', price:28000},
      {id:'s3', name:'Somtam Cumi', category:'somtam', price:28000},
      {id:'s4', name:'Somtam Rajungan/Kepiting', category:'somtam', price:30000},
      {id:'s5', name:'Somtam Kerang', category:'somtam', price:29000},
      // Tomyam
      {id:'t1', name:'Tomyam Bakso-baksoan', category:'tomyam', price:28000},
      {id:'t2', name:'Tomyam Seafood', category:'tomyam', price:32000},
      {id:'t3', name:'Tomyam Beef', category:'tomyam', price:33000},
      // Mie
      {id:'n1', name:'Mie Thai', category:'mie', price:23000},
      {id:'n2', name:'Mie Chili Oil', category:'mie', price:23000},
      // Dessert
      {id:'d1', name:'Es Jimi', category:'dessert', price:12000}
    ];

    // helpers & state
    const $ = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));
    const currency = v => 'Rp ' + v.toString().replace(/\B(?=(\d{3})+(?!\d))/g,'.');
    const catalog = $('#catalog');
    let activeCategory = 'all';
    let searchQuery = '';

    // render catalog with filtering
    function renderCatalog(){
      catalog.innerHTML = '';
      const filtered = PRODUCTS.filter(p=>{
        const matchCat = activeCategory === 'all' || p.category === activeCategory;
        const q = searchQuery.trim().toLowerCase();
        const matchQ = !q || p.name.toLowerCase().includes(q) || p.category.toLowerCase().includes(q);
        return matchCat && matchQ;
      });
      if(filtered.length === 0){
        catalog.innerHTML = `<div style="grid-column:1/-1;color:var(--muted)">Tidak ada menu yang cocok.</div>`;
        return;
      }
      filtered.forEach(p=>{
        const card = document.createElement('article');
        card.className = 'card';
        card.innerHTML = `
          <div class="thumb"><img src="https://picsum.photos/seed/${p.id}/400/300" alt="${p.name}"></div>
          <div style="margin-top:8px">
            <div class="title">${p.name}</div>
            <div class="small">${currency(p.price)}</div>
            <div class="row">
              <div class="small" style="color:var(--muted);text-transform:capitalize">${p.category}</div>
              <button class="btn" data-id="${p.id}">Tambah</button>
            </div>
          </div>
        `;
        catalog.appendChild(card);
      });
    }

    // init filters & search
    $$('.chip').forEach(ch=>{
      ch.addEventListener('click', ()=>{
        $$('.chip').forEach(x=>x.classList.remove('active'));
        ch.classList.add('active');
        activeCategory = ch.dataset.cat;
        renderCatalog();
      });
    });
    $('#search').addEventListener('input', e=>{
      searchQuery = e.target.value;
      renderCatalog();
    });

    /******** CART (localStorage) ********/
    const CART_KEY = 'mieloka_cart_v5';
    function loadCart(){ try{ return JSON.parse(localStorage.getItem(CART_KEY))||[] }catch(e){return []} }
    function saveCart(c){ localStorage.setItem(CART_KEY, JSON.stringify(c)); updateCartUI(); }
    function updateCartUI(){ const c = loadCart(); $('#cart-count').textContent = c.reduce((s,i)=>s+i.qty,0); }
    renderCatalog(); updateCartUI();

    // add to cart
    catalog.addEventListener('click', e=>{
      const btn = e.target.closest('button[data-id]');
      if(!btn) return;
      const id = btn.dataset.id;
      const p = PRODUCTS.find(x=>x.id===id);
      if(!p) return;
      const cart = loadCart();
      const found = cart.find(x=>x.id===id);
      if(found) found.qty += 1; else cart.push({...p, qty:1});
      saveCart(cart);
      // small feedback
      btn.disabled = true; btn.textContent = 'âœ“';
      setTimeout(()=>{ btn.disabled=false; btn.textContent='Tambah' }, 600);
    });

    // open modal
    $('#cart-float').addEventListener('click', ()=>{
      renderOrderSummary();
      $('#modal').style.display = 'flex';
      $('#modal').setAttribute('aria-hidden','false');
    });
    $('#btn-cancel').addEventListener('click', ()=>{ $('#modal').style.display = 'none'; $('#modal').setAttribute('aria-hidden','true'); });

    function renderOrderSummary(){
      const cart = loadCart();
      const box = $('#order-summary');
      if(cart.length === 0){ box.textContent = 'Keranjang kosong.'; return; }
      let txt = cart.map(i=>`${i.qty}Ã— ${i.name} â€” ${currency(i.price*i.qty)}`).join('\n');
      const total = cart.reduce((s,i)=>s+i.price*i.qty,0);
      txt += `\n\nTotal: ${currency(total)}`;
      box.textContent = txt;
    }

    /******** Submit to Google Form via hidden HTML form (more reliable) ********/
    function submitToGoogleFormViaHtmlForm(actionUrl, paramsObj){
      const form = document.createElement('form');
      form.style.display = 'none';
      form.method = 'POST';
      form.action = actionUrl;
      // we open to a new tab so current page doesn't navigate away
      form.target = '_blank';
      for(const key in paramsObj){
        if(!Object.prototype.hasOwnProperty.call(paramsObj,key)) continue;
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = key;
        input.value = paramsObj[key];
        form.appendChild(input);
      }
      document.body.appendChild(form);
      form.submit();
      setTimeout(()=>{ try{ document.body.removeChild(form) } catch(e){} }, 1000);
    }

    // checkout handler
    $('#checkout-form').addEventListener('submit', function(e){
      e.preventDefault();
      const cart = loadCart();
      if(cart.length === 0){ alert('Keranjang kosong.'); return; }
      const f = {
        name: $('#cust-name').value.trim(),
        tel: $('#cust-tel').value.trim(),
        addr: $('#cust-address').value.trim(),
        del: $('#cust-delivery').value,
        pay: $('#cust-pay').value,
        note: $('#cust-note').value.trim()
      };
      if(!f.name || !f.tel){ alert('Nama dan No. Telepon wajib diisi.'); return; }

      // build summary & payload object
      const orderLines = cart.map(i=>`${i.qty}Ã— ${i.name} â€” ${currency(i.qty*i.price)}`);
      const total = cart.reduce((s,i)=>s+i.price*i.qty,0);
      const orderSummary = orderLines.join('\n') + `\nTotal: ${currency(total)}\nMetode: ${f.pay}\nPengantaran: ${f.del}\nCatatan: ${f.note}`;

      const payloadObj = {};
      payloadObj[GF_ENTRY_IDS.order_summary] = orderSummary;
      payloadObj[GF_ENTRY_IDS.cust_name] = f.name;
      payloadObj[GF_ENTRY_IDS.cust_tel] = f.tel;
      payloadObj[GF_ENTRY_IDS.cust_address] = f.addr;
      payloadObj[GF_ENTRY_IDS.cust_delivery] = f.del;
      payloadObj[GF_ENTRY_IDS.cust_pay] = f.pay;
      payloadObj[GF_ENTRY_IDS.cust_note] = f.note;

      // submit via hidden HTML form to Google Form
      submitToGoogleFormViaHtmlForm(GOOGLE_FORM_ACTION_URL, payloadObj);

      // clear cart & update UI
      saveCart([]);
      renderOrderSummary();
      $('#modal').style.display = 'none';
      $('#modal').setAttribute('aria-hidden','true');

      // notify owner on WhatsApp (open new tab)
      const ownerMsg = encodeURIComponent(`Pesanan baru\nNama: ${f.name}\nTel: ${f.tel}\nPesanan:\n${orderLines.join('\n')}\nTotal: ${currency(total)}\nMetode: ${f.pay}\nPengantaran: ${f.del}\nCatatan: ${f.note}`);
      window.open(`https://wa.me/${OWNER_WA_NUMBER}?text=${ownerMsg}`, '_blank');

      // UX message
      $('#submit-message').textContent = 'Pesanan terkirim â€” data tersimpan di Google Form. Konfirmasi telah dikirim via WhatsApp.';
      // optionally copy summary to clipboard
      try{ navigator.clipboard.writeText(orderSummary); }catch(e){}
    });

    // init
    document.getElementById('year').textContent = new Date().getFullYear();
    renderCatalog();
    updateCartUI();

    // small keyboard shortcut
    document.addEventListener('keydown', e=>{ if(e.key==='c' || e.key==='C') { renderOrderSummary(); $('#modal').style.display='flex'; } });
  </script>
</body>
</html>